<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Google Meet Alternative - WebRTC PeerJS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    video { width: 300px; height: 200px; background: #000; margin: 10px; }
    #videos { display: flex; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Google Meet Alternative (WebRTC with PeerJS)</h1>
  <p>Open this page in multiple tabs or different browsers to test video calls.</p>

  <input id="roomId" placeholder="Enter room ID" />
  <button id="joinBtn">Join Room</button>

  <div id="videos">
    <video id="localVideo" autoplay muted></video>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    const localVideo = document.getElementById('localVideo');
    const videosContainer = document.getElementById('videos');
    const joinBtn = document.getElementById('joinBtn');
    const roomIdInput = document.getElementById('roomId');

    let localStream;
    let peer;
    let currentCall;
    const peers = {};

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    function addVideoStream(video, stream) {
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;
      videosContainer.appendChild(video);
    }

    joinBtn.onclick = async () => {
      const roomId = roomIdInput.value.trim();
      if (!roomId) return alert('Enter room ID');

      await initMedia();

      peer = new Peer(undefined, {
        host: window.location.hostname,
        port: 3000,
        path: '/peerjs',
      });

      peer.on('open', id => {
        console.log('My peer ID:', id);
        connectToRoom(roomId, id);
      });

      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', userVideoStream => {
          if (peers[call.peer]) return;
          const video = document.createElement('video');
          peers[call.peer] = video;
          addVideoStream(video, userVideoStream);
        });
      });
    };

    function connectToRoom(roomId, id) {
      // Simple signaling: peers in same "room" connect to each other by calling their IDs
      // This example assumes you know other peer IDs; for full implementation use a signaling server or backend

      // For demo: connect to the room ID as peer id to call
      if (id !== roomId) {
        const call = peer.call(roomId, localStream);
        call.on('stream', userVideoStream => {
          if (peers[call.peer]) return;
          const video = document.createElement('video');
          peers[call.peer] = video;
          addVideoStream(video, userVideoStream);
        });
        call.on('close', () => {
          if (peers[call.peer]) {
            peers[call.peer].remove();
            delete peers[call.peer];
          }
        });
        currentCall = call;
      }
    }
  </script>
</body>
</html>
